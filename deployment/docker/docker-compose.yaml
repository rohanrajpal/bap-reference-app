# docker-compose.yaml
# Builds and runs all three components of the BAP.

version: '3'

services:
  # The Mongo database instance, required by the protocol helper.
  database:
    container_name: database
    hostname: database
    # Pull the image from the official repos.
    image: mongo
    # Expose it on localhost port 27017.
    ports:
      - 27017:27017
    command: ['--bind_ip', '0.0.0.0']

  # The Beckn protocol client.
  client:
    container_name: client
    hostname: client
    # Build it from the docker file in the `client/` directory.
    build:
      context: client
      dockerfile: client.dockerfile
    # Expose it on localhost port 9001.
    ports:
      - 9001:9001
    # Provide configuration through environment variables
    environment:
      - DATABASE_URL=mongodb://database:27017/client
    # The protocol helper requires mongo to be running
    depends_on:
      database:
        condition: service_started

  # The Beckn protocol helper.
  protocol-helper:
    container_name: protocol-helper
    hostname: protocol-helper
    # Build it from the docker file in the `protocol-helper/` directory.
    build:
      context: protocol-helper
      dockerfile: protocol-helper.dockerfile
    # Expose it on localhost port 9002.
    ports:
      - 9002:9002
    # Provide configuration through environment variables
    environment:
      - DATABASE_URL=mongodb://database:27017/bap
    # The protocol helper requires mongo to be running
    depends_on:
      database:
        condition: service_started

  # The actual storefront UI.
  storefront-ui:
    container_name: storefront-ui
    hostname: storefront-ui
    # Build it from the docker file in the `storefront/` directory.
    build:
      context: storefront
      dockerfile: ui.dockerfile
    # Expose it on localhost port 3000.
    ports:
      - 3000:3000
    # Pass environment variables to it.
    environment:
      - MAPS_KEY=some-key
